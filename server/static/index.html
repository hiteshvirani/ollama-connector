<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Hub - Node Dashboard</title>
    <style>
        :root {
            /* Light Theme */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-accent: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --accent-primary: #818cf8;
            --accent-secondary: #a78bfa;
            --accent-success: #34d399;
            --accent-warning: #fbbf24;
            --accent-error: #f87171;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Navigation */
        .nav-bar {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .nav-links {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .nav-link:hover {
            background: var(--bg-tertiary);
            color: var(--accent-primary);
        }

        .nav-link.active {
            background: var(--gradient-accent);
            color: white;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 28px 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left h1 {
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-accent);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 42px;
            font-weight: 700;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* API Section */
        .api-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .api-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .api-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .api-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .api-toggle:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .api-content {
            display: none;
            margin-top: 20px;
        }

        .api-content.show {
            display: block;
        }

        .api-endpoint {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .api-endpoint-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .api-method {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 8px;
        }

        .method-get { background: #10b981; color: white; }
        .method-post { background: #6366f1; color: white; }

        .api-url {
            font-family: 'Courier New', monospace;
            background: var(--bg-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            color: var(--accent-primary);
            border: 1px solid var(--border-color);
            display: inline-block;
            margin: 8px 0;
        }

        .api-example {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: var(--text-primary);
            overflow-x: auto;
        }

        .copy-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }

        /* Nodes Grid */
        .nodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 24px;
        }

        .node-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .node-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }

        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .node-id {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-sm);
        }

        .status-online {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .status-offline {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .status-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .node-info {
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .info-label {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 13px;
        }

        .info-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .ip-address {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: var(--bg-tertiary);
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .models-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }

        .models-label {
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .models-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .model-tag {
            background: var(--gradient-accent);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        .model-tag:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .load-info {
            display: flex;
            gap: 20px;
            margin-top: 16px;
        }

        .load-item {
            flex: 1;
        }

        .load-label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .load-bar {
            height: 10px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .load-fill {
            height: 100%;
            background: var(--gradient-accent);
            transition: width 0.3s;
            border-radius: 10px;
        }

        .load-fill.high {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .load-fill.medium {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .last-ping-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px solid var(--border-color);
        }

        .last-ping-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .last-ping-label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .last-ping-time {
            font-size: 13px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .last-ping-time.recent {
            color: var(--accent-success);
        }

        .last-ping-time.warning {
            color: var(--accent-warning);
        }

        .last-ping-time.offline {
            color: var(--accent-error);
        }

        .ping-status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 8px currentColor;
        }

        .ping-status-indicator.online {
            background: var(--accent-success);
            color: var(--accent-success);
        }

        .ping-status-indicator.warning {
            background: var(--accent-warning);
            color: var(--accent-warning);
        }

        .ping-status-indicator.offline {
            background: var(--accent-error);
            color: var(--accent-error);
        }

        .no-nodes {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 80px;
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .no-nodes-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .no-nodes-text {
            color: var(--text-secondary);
            font-size: 18px;
            font-weight: 600;
        }

        .refresh-indicator {
            position: fixed;
            top: 24px;
            right: 24px;
            background: var(--bg-secondary);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            border: 1px solid var(--border-color);
            display: none;
            z-index: 1000;
        }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--bg-tertiary);
            border-top: 2px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nodes-grid {
                grid-template-columns: 1fr;
            }
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            .nav-bar {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Bar -->
        <nav class="nav-bar">
            <div class="nav-links">
                <a href="/" class="nav-link active">üìä Dashboard</a>
                <a href="/static/logs.html" class="nav-link">üìã Logs</a>
            </div>
            <button class="theme-toggle" id="theme-toggle">
                <span id="theme-icon">üåô</span>
                <span id="theme-text">Dark</span>
            </button>
        </nav>

        <header>
            <div class="header-left">
                <h1>ü§ñ Ollama Hub Dashboard</h1>
                <p class="subtitle">Monitor all registered Ollama nodes in real-time</p>
            </div>
        </header>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="total-nodes">0</div>
                <div class="stat-label">Total Nodes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="online-nodes">0</div>
                <div class="stat-label">Online</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-models">0</div>
                <div class="stat-label">Total Models</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="active-jobs">0</div>
                <div class="stat-label">Active Jobs</div>
            </div>
        </div>

        <!-- API Documentation Section -->
        <div class="api-section">
            <div class="api-header" id="api-toggle">
                <h2>üìö API Documentation</h2>
                <button class="api-toggle" id="api-toggle-btn">Show</button>
            </div>
            <div class="api-content" id="api-content">
                <div class="api-endpoint">
                    <div class="api-endpoint-title">
                        <span class="api-method method-get">GET</span>
                        <span>Health Check</span>
                    </div>
                    <div class="api-url">/healthz</div>
                    <p style="color: var(--text-secondary); font-size: 13px; margin: 8px 0;">Check if the server is running</p>
                    <div class="api-example">curl http://localhost:8000/healthz</div>
                </div>

                <div class="api-endpoint">
                    <div class="api-endpoint-title">
                        <span class="api-method method-get">GET</span>
                        <span>List All Nodes</span>
                    </div>
                    <div class="api-url">/nodes</div>
                    <p style="color: var(--text-secondary); font-size: 13px; margin: 8px 0;">Get information about all registered nodes</p>
                    <div class="api-example">curl http://localhost:8000/nodes</div>
                </div>

                <div class="api-endpoint">
                    <div class="api-endpoint-title">
                        <span class="api-method method-get">GET</span>
                        <span>Get Specific Node</span>
                    </div>
                    <div class="api-url">/nodes/{node_id}</div>
                    <p style="color: var(--text-secondary); font-size: 13px; margin: 8px 0;">Get detailed information about a specific node</p>
                    <div class="api-example">curl http://localhost:8000/nodes/ollama-node-1</div>
                </div>

                <div class="api-endpoint">
                    <div class="api-endpoint-title">
                        <span class="api-method method-post">POST</span>
                        <span>Submit Ollama Job (Main Endpoint)</span>
                    </div>
                    <div class="api-url">/jobs</div>
                    <p style="color: var(--text-secondary); font-size: 13px; margin: 8px 0;">Send a prompt to an Ollama model through any available node</p>
                    <div class="api-example">curl -X POST http://localhost:8000/jobs \<br>
  -H "Content-Type: application/json" \<br>
  -d '{<br>
    "model": "qwen2.5:7b",<br>
    "prompt": "Hello, how are you?",<br>
    "stream": false<br>
  }'</div>
                    <button class="copy-btn" onclick="copyToClipboard(this.previousElementSibling.textContent)">Copy Example</button>
                </div>

                <div class="api-endpoint">
                    <div class="api-endpoint-title">
                        <span class="api-method method-post">POST</span>
                        <span>Submit Job with Options</span>
                    </div>
                    <div class="api-url">/jobs</div>
                    <p style="color: var(--text-secondary); font-size: 13px; margin: 8px 0;">Submit a job with custom parameters</p>
                    <div class="api-example">curl -X POST http://localhost:8000/jobs \<br>
  -H "Content-Type: application/json" \<br>
  -d '{<br>
    "model": "qwen2.5:7b",<br>
    "prompt": "Explain quantum computing",<br>
    "options": {<br>
      "temperature": 0.7,<br>
      "top_p": 0.9,<br>
      "num_predict": 100<br>
    },<br>
    "stream": false<br>
  }'</div>
                    <button class="copy-btn" onclick="copyToClipboard(this.previousElementSibling.textContent)">Copy Example</button>
                </div>
            </div>
        </div>

        <div class="nodes-grid" id="nodes-grid">
            <div class="no-nodes">
                <div class="no-nodes-icon">‚è≥</div>
                <div class="no-nodes-text">Loading nodes...</div>
            </div>
        </div>
    </div>

    <div class="refresh-indicator" id="refresh-indicator">
        <span class="spinner"></span>
        <span>Refreshing...</span>
    </div>

    <script>
        let refreshInterval;
        let currentTheme = localStorage.getItem('theme') || 'light';

        // Theme Toggle
        function initTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            updateThemeButton();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeButton();
        }

        function updateThemeButton() {
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            if (currentTheme === 'dark') {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Light';
            } else {
                icon.textContent = 'üåô';
                text.textContent = 'Dark';
            }
        }

        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        initTheme();

        // API Toggle
        const apiToggle = document.getElementById('api-toggle');
        const apiContent = document.getElementById('api-content');
        const apiToggleBtn = document.getElementById('api-toggle-btn');
        let apiExpanded = localStorage.getItem('api-expanded') === 'true';

        function toggleAPI() {
            apiExpanded = !apiExpanded;
            if (apiExpanded) {
                apiContent.classList.add('show');
                apiToggleBtn.textContent = 'Hide';
            } else {
                apiContent.classList.remove('show');
                apiToggleBtn.textContent = 'Show';
            }
            localStorage.setItem('api-expanded', apiExpanded);
        }

        if (apiExpanded) {
            apiContent.classList.add('show');
            apiToggleBtn.textContent = 'Hide';
        }

        apiToggle.addEventListener('click', toggleAPI);

        // Copy to Clipboard
        function copyToClipboard(text) {
            const cleanText = text.replace(/<br>/g, '\n').trim();
            navigator.clipboard.writeText(cleanText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.style.background = 'var(--accent-success)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'Never';
            const now = new Date();
            const then = new Date(timestamp);
            const diff = Math.floor((now - then) / 1000);
            
            if (diff < 60) return `${diff}s ago`;
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Never';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        function getPingStatus(timestamp) {
            if (!timestamp) return { status: 'offline', class: 'offline', seconds: Infinity };
            const now = new Date();
            const then = new Date(timestamp);
            const diff = Math.floor((now - then) / 1000);
            
            if (diff <= 60) {
                return { status: 'online', class: 'recent', seconds: diff };
            } else if (diff <= 90) {
                return { status: 'warning', class: 'warning', seconds: diff };
            } else {
                return { status: 'offline', class: 'offline', seconds: diff };
            }
        }

        function getLoadClass(value) {
            if (!value) return '';
            if (value >= 0.7) return 'high';
            if (value >= 0.4) return 'medium';
            return '';
        }

        function formatPercentage(value) {
            if (value === null || value === undefined) return 'N/A';
            return `${Math.round(value * 100)}%`;
        }

        function updateStats(nodes) {
            const total = nodes.length;
            const now = new Date();
            const online = nodes.filter(n => {
                if (!n.last_seen) return false;
                const diff = Math.floor((now - new Date(n.last_seen)) / 1000);
                return diff <= 60;
            }).length;
            const totalModels = new Set(nodes.flatMap(n => n.models || [])).size;
            const activeJobs = nodes.reduce((sum, n) => sum + (n.active_jobs || 0), 0);

            document.getElementById('total-nodes').textContent = total;
            document.getElementById('online-nodes').textContent = online;
            document.getElementById('total-models').textContent = totalModels;
            document.getElementById('active-jobs').textContent = activeJobs;
        }

        function renderNodes(nodes) {
            const grid = document.getElementById('nodes-grid');
            
            if (nodes.length === 0) {
                grid.innerHTML = `
                    <div class="no-nodes">
                        <div class="no-nodes-icon">üîç</div>
                        <div class="no-nodes-text">No nodes registered yet</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = nodes.map(node => {
                const lastSeen = node.last_seen || null;
                const pingStatus = getPingStatus(lastSeen);
                
                let displayStatus = node.status || 'offline';
                if (pingStatus.status === 'offline') {
                    displayStatus = 'offline';
                } else if (pingStatus.status === 'warning') {
                    displayStatus = 'warning';
                } else if (displayStatus === 'offline' && pingStatus.status === 'online') {
                    displayStatus = 'online';
                }
                
                const statusClass = `status-${displayStatus}`;
                const ipv4 = node.ipv4 || 'N/A';
                const ipv6 = node.ipv6 || 'N/A';
                const port = node.port || 8001;
                const models = node.models || [];
                const load = node.load || {};
                const cpu = load.cpu || 0;
                const memory = load.memory || 0;
                const activeJobs = node.active_jobs || 0;
                const failureCount = node.failure_count || 0;

                return `
                    <div class="node-card">
                        <div class="node-header">
                            <div class="node-id">${escapeHtml(node.node_id)}</div>
                            <div class="status-badge ${statusClass}">${displayStatus}</div>
                        </div>
                        
                        <div class="node-info">
                            <div class="info-row">
                                <span class="info-label">IPv4:</span>
                                <span class="info-value ip-address">${escapeHtml(ipv4)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">IPv6:</span>
                                <span class="info-value ip-address">${escapeHtml(ipv6)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Port:</span>
                                <span class="info-value">${port}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Active Jobs:</span>
                                <span class="info-value">${activeJobs}</span>
                            </div>
                            ${failureCount > 0 ? `
                            <div class="info-row">
                                <span class="info-label">Failures:</span>
                                <span class="info-value" style="color: var(--accent-error);">${failureCount}</span>
                            </div>
                            ` : ''}
                        </div>

                        ${cpu !== null || memory !== null ? `
                        <div class="load-info">
                            ${cpu !== null ? `
                            <div class="load-item">
                                <div class="load-label">CPU</div>
                                <div class="load-bar">
                                    <div class="load-fill ${getLoadClass(cpu)}" style="width: ${cpu * 100}%"></div>
                                </div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px; font-weight: 600;">${formatPercentage(cpu)}</div>
                            </div>
                            ` : ''}
                            ${memory !== null ? `
                            <div class="load-item">
                                <div class="load-label">Memory</div>
                                <div class="load-bar">
                                    <div class="load-fill ${getLoadClass(memory)}" style="width: ${memory * 100}%"></div>
                                </div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px; font-weight: 600;">${formatPercentage(memory)}</div>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}

                        ${models.length > 0 ? `
                        <div class="models-section">
                            <div class="models-label">Available Models (${models.length})</div>
                            <div class="models-list">
                                ${models.map(model => `<span class="model-tag">${escapeHtml(model)}</span>`).join('')}
                            </div>
                        </div>
                        ` : `
                        <div class="models-section">
                            <div class="models-label" style="color: var(--text-tertiary);">No models available</div>
                        </div>
                        `}

                        <div class="last-ping-section">
                            <div class="last-ping-row">
                                <span class="last-ping-label">Last Ping</span>
                                <span class="last-ping-time ${pingStatus.class}">
                                    <span class="ping-status-indicator ${pingStatus.status}"></span>
                                    ${lastSeen ? formatTimeAgo(lastSeen) : 'Never'}
                                </span>
                            </div>
                            ${lastSeen ? `
                            <div class="last-ping-row" style="margin-top: 6px;">
                                <span class="last-ping-label" style="font-size: 10px;">Timestamp</span>
                                <span style="font-size: 11px; color: var(--text-tertiary); font-family: 'Courier New', monospace;">
                                    ${formatTimestamp(lastSeen)}
                                </span>
                            </div>
                            ${pingStatus.seconds > 60 ? `
                            <div style="margin-top: 8px; padding: 10px; background: ${pingStatus.status === 'offline' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; border-radius: 8px; font-size: 12px; color: ${pingStatus.status === 'offline' ? 'var(--accent-error)' : 'var(--accent-warning)'}; font-weight: 600; border: 1px solid ${pingStatus.status === 'offline' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(245, 158, 11, 0.2)'};">
                                ‚ö†Ô∏è ${pingStatus.seconds > 90 ? 'Node appears offline' : 'No ping received in last 60 seconds'}
                            </div>
                            ` : ''}
                            ` : `
                            <div style="margin-top: 8px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; font-size: 12px; color: var(--accent-error); font-weight: 600; border: 1px solid rgba(239, 68, 68, 0.2);">
                                ‚ö†Ô∏è Node has never pinged
                            </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function fetchNodes() {
            try {
                document.getElementById('refresh-indicator').style.display = 'block';
                const response = await fetch('/nodes');
                if (!response.ok) throw new Error('Failed to fetch nodes');
                const nodes = await response.json();
                
                updateStats(nodes);
                renderNodes(nodes);
            } catch (error) {
                console.error('Error fetching nodes:', error);
                document.getElementById('nodes-grid').innerHTML = `
                    <div class="no-nodes">
                        <div class="no-nodes-icon">‚ùå</div>
                        <div class="no-nodes-text">Error loading nodes: ${escapeHtml(error.message)}</div>
                    </div>
                `;
            } finally {
                document.getElementById('refresh-indicator').style.display = 'none';
            }
        }

        // Initial load
        fetchNodes();

        // Auto-refresh every 5 seconds
        refreshInterval = setInterval(fetchNodes, 5000);

        // Also refresh on window focus
        window.addEventListener('focus', fetchNodes);
    </script>
</body>
</html>
